<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTB Planner üíú Lu Edition</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@500;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:        #fdfaff;
      --card:      rgba(255,255,255,0.94);
      --text:      #1e1435;
      --muted:     #6b5a94;
      --lav:       #b19cf9;
      --lav2:      #d2c8ff;
      --lav3:      #f0eaff;
      --lav-soft:  #e9e1ff;
      --stroke:    rgba(140,110,200,0.18);
      --shadow:    0 14px 38px rgba(80,40,140,0.11);
      --shadow-sm: 0 6px 16px  rgba(80,40,140,0.08);
      --radius:    20px;
      --radius-lg: 28px;
    }

    * { box-sizing: border-box; margin:0; padding:0; }

    body {
      font-family: 'Quicksand', system-ui, sans-serif;
      background:
        radial-gradient(ellipse at 12% 8%,  var(--lav3) 0%, transparent 45%),
        radial-gradient(ellipse at 88% 18%, var(--lav-soft) 0%, transparent 50%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(253,250,255,0.82);
      border-bottom: 1px solid var(--stroke);
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px 18px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 48px; height: 48px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--lav), var(--lav2));
      color: white;
      font-family: 'Unbounded', cursive;
      font-weight: 700;
      font-size: 24px;
      display: grid; place-items: center;
      box-shadow: var(--shadow-sm);
    }

    .title h1 { font-family: 'Unbounded', cursive; font-size: 22px; letter-spacing: -0.2px; }
    .title p  { font-size: 13px; color: var(--muted); font-weight: 600; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    button, .btn {
      border: none;
      border-radius: 14px;
      padding: 10px 16px;
      font-weight: 650;
      cursor: pointer;
      transition: all 0.18s ease;
      font-family: inherit;
    }

    .btn-outline {
      background: rgba(255,255,255,0.75);
      border: 1px solid var(--stroke);
      color: var(--text);
    }
    .btn-outline:hover { background: white; transform: translateY(-1px); }

    .btn-primary {
      background: linear-gradient(135deg, var(--lav), #9f85f5);
      color: white;
      box-shadow: 0 6px 16px rgba(161,140,250,0.28);
    }
    .btn-primary:hover { transform: translateY(-1.5px); box-shadow: 0 10px 24px rgba(161,140,250,0.36); }

    .btn-danger {
      background: rgba(250,80,110,0.08);
      color: #d32f2f;
      border: 1px solid rgba(244,67,54,0.22);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(255,255,255,0.65);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-weight: 650;
      cursor: pointer;
      transition: 0.2s;
    }

    .tab.active {
      background: linear-gradient(135deg, rgba(177,156,249,0.22), rgba(210,200,255,0.18));
      color: var(--text);
      border-color: rgba(177,156,249,0.5);
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 18px 80px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 20px;
      backdrop-filter: blur(8px);
    }

    h2 { font-family: 'Unbounded', cursive; font-size: 20px; margin-bottom: 8px; }
    .subtitle { color: var(--muted); font-weight: 600; font-size: 14px; }

    /* Horario */
    .calendar-wrap {
      margin-top: 16px;
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.6);
    }

    .cal-grid {
      display: grid;
      grid-template-columns: 70px repeat(6, minmax(160px, 1fr));
      min-width: 1100px;
    }

    .cal-head {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(253,250,255,0.92);
      backdrop-filter: blur(12px);
    }

    .cal-head .cell {
      padding: 12px 8px;
      font-weight: 700;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      border-bottom: 1px solid var(--stroke);
    }

    .time-cell { justify-content: flex-end; padding-right: 12px; color: var(--muted); font-weight: 700; }

    .day-col {
      position: relative;
      min-height: 720px;
      border-right: 1px solid var(--stroke);
    }

    .hour-row {
      height: 48px;
      border-bottom: 1px dashed rgba(140,110,200,0.12);
    }

    .class-block {
      position: absolute;
      left: 8px; right: 8px;
      border-radius: 16px;
      padding: 10px 12px;
      color: #1e1435;
      font-weight: 700;
      font-size: 13.5px;
      box-shadow: 0 10px 24px rgba(80,40,140,0.14);
      border: 1px solid rgba(255,255,255,0.65);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      overflow: hidden;
    }

    .class-block:hover {
      transform: scale(1.015);
      box-shadow: 0 14px 32px rgba(80,40,140,0.20);
    }

    .class-block .top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
    }

    .class-block .tag {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(255,255,255,0.8);
      white-space: nowrap;
    }

    /* Malla */
    .semestre {
      border-radius: var(--radius-lg);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.7);
      padding: 18px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
    }

    .semestre h3 {
      font-family: 'Unbounded', cursive;
      font-size: 17px;
      margin-bottom: 14px;
    }

    .malla-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }

    .materia {
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(240,225,255,0.35);
      padding: 14px;
      cursor: pointer;
      transition: all 0.16s;
    }

    .materia:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }

    .materia.done {
      background: rgba(177,156,249,0.18);
      border-color: rgba(177,156,249,0.4);
    }

    .materia.done .name { text-decoration: line-through; opacity: 0.92; }

    .materia.locked {
      opacity: 0.48;
      filter: grayscale(0.4);
      pointer-events: none;
    }

    .materia .top {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 13px;
      color: #4a3782;
    }

    .materia .name {
      margin-top: 8px;
      font-weight: 650;
      line-height: 1.3;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(30,20,60,0.52);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal.show { display: flex; }

    .modal-box {
      width: min(620px, 96%);
      max-height: 92vh;
      overflow-y: auto;
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: 0 30px 90px rgba(40,20,80,0.28);
      border: 1px solid rgba(255,255,255,0.6);
      backdrop-filter: blur(16px);
      padding: 24px;
    }

    .modal h3 { font-family: 'Unbounded', cursive; font-size: 22px; margin-bottom: 16px; }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }

    .field { display: flex; flex-direction: column; gap: 6px; }

    .field label { font-size: 13px; font-weight: 700; color: var(--muted); }

    input, select {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.85);
      font-family: inherit;
      font-weight: 600;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">U</div>
        <div class="title">
          <h1>UTB Planner</h1>
          <p>Horario + Malla + Progreso ‚Ä¢ Lavanda vibes üíú</p>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-outline" id="btn-savio">üåê Savio</button>
        <button class="btn btn-outline" id="btn-export">üíæ Exportar</button>
        <button class="btn btn-danger" id="btn-reset">üóë Reset</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="home">üè† Inicio</div>
      <div class="tab" data-tab="horario">üìÖ Horario</div>
      <div class="tab" data-tab="malla">üìö Malla</div>
    </div>
  </div>
</header>

<main>

  <!-- INICIO -->
  <section id="tab-home">
    <div class="card" style="margin-bottom:24px;">
      <h2>¬°Hola Lu! üíú</h2>
      <p class="subtitle">Aqu√≠ organizas tu semestre sin morir en el intento</p>
      <div style="margin:20px 0; display:flex; flex-wrap:wrap; gap:12px;">
        <button class="btn btn-primary" onclick="goTab('horario')">Ver / editar horario</button>
        <button class="btn btn-primary" onclick="goTab('malla')">Ver / marcar malla</button>
      </div>
    </div>

    <div class="card">
      <h2>Progreso r√°pido</h2>
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-top:16px;">
        <div style="text-align:center; padding:16px; border-radius:16px; background:rgba(177,156,249,0.1); border:1px solid rgba(177,156,249,0.3);">
          <div style="font-size:32px; font-family:'Unbounded'; font-weight:700;" id="stat-clases">0</div>
          <div style="color:var(--muted); font-weight:600;">clases</div>
        </div>
        <div style="text-align:center; padding:16px; border-radius:16px; background:rgba(177,156,249,0.1); border:1px solid rgba(177,156,249,0.3);">
          <div style="font-size:32px; font-family:'Unbounded'; font-weight:700;" id="stat-aprob">0</div>
          <div style="color:var(--muted); font-weight:600;">materias aprobadas</div>
        </div>
        <div style="text-align:center; padding:16px; border-radius:16px; background:rgba(177,156,249,0.1); border:1px solid rgba(177,156,249,0.3);">
          <div style="font-size:32px; font-family:'Unbounded'; font-weight:700;" id="stat-prog">0%</div>
          <div style="color:var(--muted); font-weight:600;">progreso malla</div>
        </div>
      </div>
    </div>
  </section>

  <!-- HORARIO -->
  <section id="tab-horario" style="display:none;">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:16px;">
        <div>
          <h2>Horario semanal</h2>
          <p class="subtitle">Click en bloque ‚Üí editar / eliminar / detalles</p>
        </div>
        <button class="btn btn-primary" onclick="openClassModal()">+ Agregar clase</button>
      </div>

      <div class="calendar-wrap">
        <div class="cal-grid cal-head">
          <div class="cell">Hora</div>
          <div class="cell">Lunes</div>
          <div class="cell">Martes</div>
          <div class="cell">Mi√©r</div>
          <div class="cell">Jueves</div>
          <div class="cell">Viernes</div>
          <div class="cell">S√°bado</div>
        </div>
        <div class="cal-grid" id="calBody"></div>
      </div>
    </div>
  </section>

  <!-- MALLA -->
  <section id="tab-malla" style="display:none;">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:16px;">
        <div>
          <h2>Malla curricular</h2>
          <p class="subtitle">Click para (des)marcar aprobada ‚Ä¢ Click derecho ‚Üí ver prereqs</p>
        </div>
      </div>
      <div id="malla-container"></div>
    </div>
  </section>

</main>

<footer>
  Hecho con üíú para que el semestre sea un poquito m√°s llevadero
</footer>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box" id="modal-content"></div>
</div>

<script>
// =============================================
// CONFIGURACI√ìN GENERAL
// =============================================

const STORAGE_KEY = "utb_lu_planner_v3";

const DAYS = ["Lun","Mar","Mi√©","Jue","Vie","S√°b"];
const START_HOUR = 6;
const END_HOUR   = 21;
const SLOT_HEIGHT = 48;

// =============================================
// MALLA COMPLETA
// =============================================

const malla = [
  // Semestre 1
  { code:"CHUM-H01A", nombre:"TALLER DE COMPRENSI√ìN LECTORA", sem:1, cr:2, prereq:[] },
  { code:"CBAS-M01A", nombre:"C√ÅLCULO DIFERENCIAL", sem:1, cr:4, prereq:[] },
  { code:"CBAS-M02A", nombre:"MATEM√ÅTICAS B√ÅSICAS", sem:1, cr:3, prereq:[] },
  { code:"CBAS-Q01A", nombre:"QU√çMICA GENERAL", sem:1, cr:3, prereq:[] },
  { code:"ECOU-U01A", nombre:"DESARROLLO UNIVERSITARIO", sem:1, cr:2, prereq:[] },
  { code:"IMEC-D01A", nombre:"EXPRESI√ìN GR√ÅFICA", sem:1, cr:2, prereq:[] },
  { code:"IMTR-B01A", nombre:"SEMINARIO DE ING. MECATR√ìNICA", sem:1, cr:1, prereq:[] },
  { code:"ISCO-C02A", nombre:"FUNDAMENTOS DE PROGRAMACI√ìN", sem:1, cr:3, prereq:[] },

  // Semestre 2
  { code:"CHUL-LE3A", nombre:"LENGUA EXTRANJERA III", sem:2, cr:2, prereq:[] },
  { code:"CBAS-F01A", nombre:"F√çSICA MEC√ÅNICA", sem:2, cr:4, prereq:["CBAS-M01A","CBAS-M02A"] },
  { code:"CBAS-M03A", nombre:"C√ÅLCULO INTEGRAL", sem:2, cr:4, prereq:["CBAS-M01A"] },
  { code:"CBAS-M04A", nombre:"√ÅLGEBRA LINEAL", sem:2, cr:3, prereq:[] },
  { code:"IMTR-M01A", nombre:"TALLER DE MECATR√ìNICA", sem:2, cr:2, prereq:["IMTR-B01A"] },
  { code:"ISCO-C03A", nombre:"PROGRAMACI√ìN", sem:2, cr:3, prereq:["ISCO-C02A"] },

  // Semestre 3
  { code:"CHUL-LE4A", nombre:"LENGUA EXTRANJERA IV", sem:3, cr:2, prereq:["CHUL-LE3A"] },
  { code:"CHUM-H02A", nombre:"TALLER DE ESCRITURA ACAD√âMICA", sem:3, cr:2, prereq:[] },
  { code:"CBAS-E01A", nombre:"ESTAD√çSTICA Y PROBABILIDAD", sem:3, cr:3, prereq:[] },
  { code:"CBAS-F02A", nombre:"F√çSICA ELECTRICIDAD Y MAGNETISMO", sem:3, cr:4, prereq:["CBAS-M03A","CBAS-F01A"] },
  { code:"CBAS-M05A", nombre:"C√ÅLCULO VECTORIAL", sem:3, cr:4, prereq:["CBAS-M03A","CBAS-M04A"] },
  { code:"IETR-F02A", nombre:"SISTEMAS DIGITALES I", sem:3, cr:3, prereq:["ISCO-C02A"] },

  // Semestre 4
  { code:"CHUL-LE5A", nombre:"LENGUA EXTRANJERA V", sem:4, cr:2, prereq:["CHUL-LE4A"] },
  { code:"CHUM-H03A", nombre:"CONSTITUCI√ìN POL√çTICA", sem:4, cr:2, prereq:[] },
  { code:"CBAS-F03A", nombre:"F√çSICA CALOR Y ONDAS", sem:4, cr:4, prereq:["CBAS-F02A","CBAS-M04A"] },
  { code:"CBAS-M06A", nombre:"ECUACIONES DIFERENCIALES Y EN", sem:4, cr:4, prereq:["CBAS-M05A"] },
  { code:"IELE-F03A", nombre:"CIRCUITOS EL√âCTRICOS I", sem:4, cr:3, prereq:["CBAS-F02A"] },
  { code:"IMEC-D03A", nombre:"EST√ÅTICA", sem:4, cr:3, prereq:["CBAS-F01A","CBAS-M04A"] },

  // Semestre 5
  { code:"IETR-F03A", nombre:"SE√ëALES Y SISTEMAS", sem:5, cr:3, prereq:["CBAS-M06A"] },
  { code:"IMEC-D04A", nombre:"DIN√ÅMICA", sem:5, cr:3, prereq:["IMEC-D03A"] },
  { code:"IMEC-F08A", nombre:"TERMODIN√ÅMICA Y FLUIDOS", sem:5, cr:3, prereq:["CBAS-M06A"] },
  { code:"IMEC-M01A", nombre:"MATERIALES I", sem:5, cr:3, prereq:["CBAS-Q01A"] },
  { code:"ISCO-C07A", nombre:"PROCESAMIENTO NUM√âRICO", sem:5, cr:3, prereq:["ISCO-C03A","CBAS-M06A"] },

  // Semestre 6
  { code:"AEMP-G04A", nombre:"CREATIVIDAD Y EMPRENDIMIENTO", sem:6, cr:2, prereq:[] },
  { code:"IETR-C01A", nombre:"CONTROL I", sem:6, cr:3, prereq:["IETR-F03A"] },
  { code:"IETR-F04A", nombre:"ELECTR√ìNICA I", sem:6, cr:3, prereq:["IELE-F03A"] },
  { code:"IMEC-D06A", nombre:"RESISTENCIAS DE MATERIALES", sem:6, cr:3, prereq:["IMEC-D03A"] },
  { code:"IMEC-M03A", nombre:"TECNOLOG√çA DE FABRICACI√ìN", sem:6, cr:3, prereq:["IMEC-M01A"] },

  // Semestre 7
  { code:"CHUM-HU1A", nombre:"ELECTIVA DE HUMANIDADES I", sem:7, cr:2, prereq:[] },
  { code:"ECON-M12A", nombre:"FORMULACI√ìN Y EVALUACI√ìN DE PR", sem:7, cr:3, prereq:["CBAS-E01A"] },
  { code:"IETR-D03A", nombre:"SISTEMAS EMBEBIDOS", sem:7, cr:3, prereq:["IETR-F02A"] },
  { code:"IMTR-A01A", nombre:"SENSORES E INSTRUMENTACI√ìN", sem:7, cr:3, prereq:["IETR-F04A","IMEC-D06A","IETR-F03A"] },
  { code:"IMTR-A02A", nombre:"SISTEMAS AUTOM√ÅTICOS DE PRODUCCI√ìN", sem:7, cr:3, prereq:["IMEC-F08A","IETR-F02A","IMTR-M01A"] },
  { code:"IMTR-EC1A", nombre:"ELECTIVA COMPLEMENTARIA I", sem:7, cr:2, prereq:[] },

  // Semestre 8
  { code:"CHUM-H05A", nombre:"CIUDADAN√çA GLOBAL", sem:8, cr:2, prereq:[] },
  { code:"IETR-C04A", nombre:"ELECTR√ìNICA DE POTENCIA", sem:8, cr:3, prereq:["IETR-F04A"] },
  { code:"IMTR-A03A", nombre:"ROB√ìTICA", sem:8, cr:3, prereq:["IMEC-D04A","IETR-C01A"] },
  { code:"IMTR-C01A", nombre:"SISTEMAS MECATR√ìNICOS PROGRAMABLES", sem:8, cr:3, prereq:["IELE-F03A","IETR-F02A","IMTR-M01A"] },
  { code:"IMTR-EC2A", nombre:"ELECTIVA COMPLEMENTARIA II", sem:8, cr:2, prereq:[] },
  { code:"IMTR-P01A", nombre:"PROYECTO DE INGENIER√çA I", sem:8, cr:2, prereq:[] },

  // Semestre 9
  { code:"CHUM-H04A", nombre:"√âTICA", sem:9, cr:2, prereq:[] },
  { code:"IMTR-A04A", nombre:"CONTROL INTELIGENTE", sem:9, cr:3, prereq:["IETR-C01A","IMTR-C01A"] },
  { code:"IMTR-D01A", nombre:"DISE√ëOS MECATR√ìNICOS", sem:9, cr:3, prereq:["IMTR-A01A","IMTR-C01A","IMTR-A03A"] },
  { code:"IMTR-ECA3", nombre:"ELECTIVA COMPLEMENTARIA III", sem:9, cr:2, prereq:[] },
  { code:"IMTR-ECA4", nombre:"ELECTIVA COMPLEMENTARIA IV", sem:9, cr:2, prereq:[] },
  { code:"IMTR-P02A", nombre:"PROYECTO DE INGENIER√çA II", sem:9, cr:2, prereq:["IMTR-P01A"] },

  // Semestre 10
  { code:"CHUM-HU2A", nombre:"ELECTIVA DE HUMANIDADES II", sem:10, cr:2, prereq:[] },
  { code:"IIND-EE1A", nombre:"ELECTIVA EMPRESARIAL", sem:10, cr:2, prereq:[] },
  { code:"IMTR-P03A", nombre:"PR√ÅCTICA PROFESIONAL", sem:10, cr:6, prereq:[] }
];

// =============================================
// ESTADO
// =============================================

let state = {
  clases: [],
  aprobadas: []
};

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    state.clases = data.clases || [];
    state.aprobadas = data.aprobadas || [];
  } catch(e) {}
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  updateQuickStats();
}

// =============================================
// TABS
// =============================================

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    document.querySelectorAll('section[id^="tab-"]').forEach(s => s.style.display = 'none');
    document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';

    if (tab.dataset.tab === 'horario') renderHorario();
    if (tab.dataset.tab === 'malla')   renderMalla();
  });
});

function goTab(tabName) {
  document.querySelector(`.tab[data-tab="${tabName}"]`).click();
}

// =============================================
// UTILIDADES
// =============================================

function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return String(text || "").replace(/[&<>"']/g, m => map[m]);
}

function hhmmToMin(hhmm) {
  const [h, m] = hhmm.split(':').map(Number);
  return h * 60 + m;
}

function minToTop(minutes) {
  return ((minutes - START_HOUR * 60) / 60) * SLOT_HEIGHT;
}

function createId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

// =============================================
// HORARIO
// =============================================

function renderHorario() {
  const body = document.getElementById('calBody');
  body.innerHTML = '';

  // Columna de horas
  const timeCol = document.createElement('div');
  timeCol.className = 'day-col';
  for (let h = START_HOUR; h < END_HOUR; h++) {
    const row = document.createElement('div');
    row.className = 'hour-row time-cell';
    row.textContent = `${String(h).padStart(2,'0')}:00`;
    timeCol.appendChild(row);
  }
  body.appendChild(timeCol);

  // D√≠as
  for (let d = 1; d <= 6; d++) {
    const col = document.createElement('div');
    col.className = 'day-col';
    col.dataset.day = d;
    for (let h = START_HOUR; h < END_HOUR; h++) {
      const row = document.createElement('div');
      row.className = 'hour-row';
      col.appendChild(row);
    }
    body.appendChild(col);
  }

  state.clases.forEach(cl => renderOneClass(cl));
}

function renderOneClass(cl) {
  const col = document.querySelector(`.day-col[data-day="${cl.dia}"]`);
  if (!col) return;

  const start = hhmmToMin(cl.inicio);
  const end   = hhmmToMin(cl.fin);
  const topPx    = minToTop(start);
  const heightPx = ((end - start) / 60) * SLOT_HEIGHT;

  const block = document.createElement('div');
  block.className = 'class-block';
  block.style.top = topPx + 'px';
  block.style.height = heightPx + 'px';
  block.style.background = `linear-gradient(135deg, ${cl.color}88, ${cl.color}cc)`;

  block.innerHTML = `
    <div class="top">
      <div>${escapeHtml(cl.nombre)}</div>
      <div class="tag">${escapeHtml(cl.salon || '‚Äî')}</div>
    </div>
    <div style="margin-top:4px; font-size:12px; opacity:0.9;">
      ${cl.inicio} ‚Äì ${cl.fin} ‚Ä¢ ${escapeHtml(cl.profe || '‚Äî')}
    </div>
  `;

  block.onclick = () => openClassModal(cl.id);
  col.appendChild(block);
}

// =============================================
// MODAL CLASE
// =============================================

let currentEditId = null;

function openClassModal(editId = null) {
  currentEditId = editId;
  const cl = editId ? state.clases.find(c => c.id === editId) : null;

  const html = `
    <h3>${cl ? 'Editar clase' : 'Nueva clase'}</h3>

    <div class="form-grid">
      <div class="field">
        <label>Nombre / Materia</label>
        <input id="c-nombre" value="${cl?.nombre || ''}" placeholder="Ej: C√°lculo Diferencial"/>
      </div>
      <div class="field">
        <label>Color</label>
        <input type="color" id="c-color" value="${cl?.color || '#b19cf9'}"/>
      </div>

      <div class="field">
        <label>D√≠a</label>
        <select id="c-dia">
          ${DAYS.map((d,i) => `<option value="${i+1}" ${cl?.dia === i+1 ? 'selected' : ''}>${d}</option>`).join('')}
        </select>
      </div>
      <div class="field">
        <label>Sal√≥n</label>
        <input id="c-salon" value="${cl?.salon || ''}" placeholder="Ej: B-304"/>
      </div>

      <div class="field">
        <label>Inicio</label>
        <input type="time" id="c-inicio" value="${cl?.inicio || '07:00'}"/>
      </div>
      <div class="field">
        <label>Fin</label>
        <input type="time" id="c-fin" value="${cl?.fin || '09:00'}"/>
      </div>

      <div class="field">
        <label>Profesor</label>
        <input id="c-profe" value="${cl?.profe || ''}" placeholder="Opcional"/>
      </div>
      <div class="field">
        <label>Nota / recordatorio</label>
        <input id="c-nota" value="${cl?.nota || ''}" placeholder="Ej: Parcial 30%"/>
      </div>
    </div>

    <div class="modal-footer">
      ${cl ? `<button class="btn btn-danger" onclick="deleteClass()">Eliminar</button>` : ''}
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveClass()">${cl ? 'Actualizar' : 'Guardar'}</button>
    </div>
  `;

  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal').classList.add('show');
}

function deleteClass() {
  if (!currentEditId) return;
  if (!confirm("¬øSegura que quieres eliminar esta clase?")) return;

  state.clases = state.clases.filter(c => c.id !== currentEditId);
  saveState();
  closeModal();
  renderHorario();
}

function saveClass() {
  const nombre = document.getElementById('c-nombre').value.trim();
  const color  = document.getElementById('c-color').value;
  const dia    = Number(document.getElementById('c-dia').value);
  const salon  = document.getElementById('c-salon').value.trim();
  const inicio = document.getElementById('c-inicio').value;
  const fin    = document.getElementById('c-fin').value;
  const profe  = document.getElementById('c-profe').value.trim();
  const nota   = document.getElementById('c-nota').value.trim();

  if (!nombre) return alert("Falta el nombre de la materia");
  if (hhmmToMin(fin) <= hhmmToMin(inicio)) return alert("La hora final debe ser mayor");

  const payload = { nombre, color, dia, salon, inicio, fin, profe, nota };

  if (currentEditId) {
    const index = state.clases.findIndex(c => c.id === currentEditId);
    if (index !== -1) {
      state.clases[index] = { ...state.clases[index], ...payload };
    }
  } else {
    payload.id = createId();
    state.clases.push(payload);
  }

  saveState();
  closeModal();
  renderHorario();
}

// =============================================
// MALLA
// =============================================

function renderMalla() {
  const cont = document.getElementById('malla-container');
  cont.innerHTML = '';

  const bySem = {};
  malla.forEach(m => {
    const s = m.sem;
    if (!bySem[s]) bySem[s] = [];
    bySem[s].push(m);
  });

  Object.keys(bySem).sort((a,b) => a - b).forEach(sem => {
    const box = document.createElement('div');
    box.className = 'semestre';
    box.innerHTML = `<h3>Semestre ${sem}</h3>`;

    const grid = document.createElement('div');
    grid.className = 'malla-grid';

    bySem[sem].forEach(mat => {
      const done = state.aprobadas.includes(mat.code);
      const unlocked = (mat.prereq || []).every(p => state.aprobadas.includes(p));

      const el = document.createElement('div');
      el.className = `materia ${done ? 'done' : ''} ${!unlocked && !done ? 'locked' : ''}`;
      el.innerHTML = `
        <div class="top">
          <span>${escapeHtml(mat.code)}</span>
          <span>${mat.cr ? mat.cr + ' cr' : ''}</span>
        </div>
        <div class="name">${escapeHtml(mat.nombre)}</div>
      `;

      el.onclick = () => {
        if (done) {
          state.aprobadas = state.aprobadas.filter(c => c !== mat.code);
        } else if (unlocked) {
          state.aprobadas.push(mat.code);
        } else {
          alert("Faltan prerrequisitos:\n" + (mat.prereq || []).join(", "));
          return;
        }
        saveState();
        renderMalla();
      };

      el.oncontextmenu = e => {
        e.preventDefault();
        alert("Prerrequisitos:\n" + ((mat.prereq || []).length ? mat.prereq.join(", ") : "Ninguno"));
      };

      grid.appendChild(el);
    });

    box.appendChild(grid);
    cont.appendChild(box);
  });

  updateQuickStats();
}

// =============================================
// STATS + BOTONES
// =============================================

function updateQuickStats() {
  document.getElementById('stat-clases').textContent = state.clases.length;
  document.getElementById('stat-aprob').textContent  = state.aprobadas.length;

  const total = malla.length || 1;
  const pct = Math.round((state.aprobadas.length / total) * 100);
  document.getElementById('stat-prog').textContent = pct + '%';
}

document.getElementById('btn-savio').onclick = () => window.open('https://savio.utb.edu.co', '_blank');

document.getElementById('btn-export').onclick = () => {
  const blob = new Blob([JSON.stringify({ ...state, malla }, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'utb-lu-backup.json';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('btn-reset').onclick = () => {
  if (!confirm("¬øBorrar TODO (horario + malla)?")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = { clases: [], aprobadas: [] };
  renderHorario();
  renderMalla();
  updateQuickStats();
  goTab('home');
};

function closeModal() {
  document.getElementById('modal').classList.remove('show');
}

// =============================================
// INICIO
// =============================================

loadState();
renderHorario();
renderMalla();
updateQuickStats();
goTab('home');

</script>
</body>
</html>